{"version":3,"sources":["alchemy.js"],"names":["window","document","AO","on","tinymce","initialSettings","tinyMCEPreInit","mceInit","$","$userProfileContainer","$metaboxes","$alchemy","pageID","$alchOptions","searchParams","currentUrl","URL","location","href","popperInstances","get","$fields","constrFields","$field","field","children","$children","i","child","type","find","each","push","$button","Function","alchemy","this","map","destroy","data","attr","removeClass","text","concat","id","instance","next","ajax","saveOptionsData","AlchemyData","dataType","all","fieldsPromises","then","values","success","append","nonce","reload","JSON","stringify","error","responseJSON","messsages","topMostPosition","url","contentType","$tooltip","blockTop","offset","code","Popper","modifiers","fallbackPlacements","top","parents","addClass","createPopper","placement","name","options","one","hasClass","removeAttr","add","animate","scrollTop","preventDefault","subscribe","editor","closest","$postBox","isSavingPost","saved","remove","save_metadata","$postForm","e","$trigger","$profileForm","wp","select","click","userProfileData","userID","method","processData","submit","saveMetaboxesData","Promise","postID","jQuery"],"mappings":"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","file":"alchemy.min.js","sourcesContent":["'use strict';\n\n((window, document, $) => {\n    window.AO = window.AO || {};\n\n    $(document).on('tinymce-editor-init', () => {\n        AO.tinymce = AO.tinymce || {};\n        AO.tinymce.initialSettings = tinyMCEPreInit.mceInit['alchemy-temp-editor'];\n    });\n\n    $(() => {\n        const $alchemy = $('.jsAlchemy');\n        const $metaboxes = $('.jsAlchemyMetaBox');\n        const $userProfileContainer = $('.jsAlchemyUserProfile');\n\n        if( ! $alchemy ) {\n            return;\n        }\n\n        const $alchOptions = $('.jsAlchemyOptions');\n        const currentUrl = new URL(window.location.href);\n        const pageID = currentUrl.searchParams.get('page') || currentUrl.searchParams.get('post');\n        const data = new FormData();\n        const popperInstances = {};\n\n        const $fields = $alchOptions.children('.jsAlchemyField');\n        const constrFields = [];\n\n        $fields.each((i, field) => {\n            const $field = $(field);\n\n            if( 'sections' === $field.data('alchemy').type ) {\n                const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\n\n                if( $children[0] ) {\n                    $children.each((i, child) => {\n                        constrFields.push($(child));\n                    });\n                }\n            } else {\n                constrFields.push($field);\n            }\n        });\n\n        $alchemy.on('click', '.jsAlchemySaveOptions', function() {\n            const $button = $(this);\n            const fieldsPromises = $(constrFields).map((i, $field) => {\n                const alchemy = $field.data('alchemy');\n\n                $field.removeClass('alchemy__field--invalid').children('.jsAlchemyValidationTooltip').find('.jsAlchemyTooltipText').text('');\n\n                return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\n            }).get();\n\n            $.each(popperInstances, (i, instance) => {\n                instance.destroy();\n            });\n\n            $button.attr('disabled', true).next('.jsAlchemyLoader').removeClass('alchemy__spinner--hidden');\n\n            let saveOptionsData = AlchemyData['save-options'];\n\n            if( $button.data() && 'network' === $button.data('type') ) {\n                saveOptionsData = AlchemyData['save-network-options'];\n            }\n\n            Promise.all(fieldsPromises).then(values => {\n                data.append('_wpnonce', saveOptionsData.nonce);\n                data.append('page-id', pageID);\n                data.append('values', JSON.stringify(values));\n\n                $.ajax({\n                    method: \"POST\",\n                    url: saveOptionsData.url,\n                    dataType: 'json',\n                    processData: false,\n                    contentType: false,\n                    data: data,\n                    success: () => {\n                        window.location.reload();\n                    },\n                    error: error => {\n                        if( error.responseJSON.data && 'alch-save-validation-errors' === error.responseJSON.code ) {\n                            const messsages = error.responseJSON.data['invalid-fields'];\n\n                            let topMostPosition = 0;\n\n                            $(constrFields).each((i, $field) => {\n                                const alchemy = $field.data('alchemy');\n\n                                if( messsages[alchemy.id] ) {\n                                    const $tooltip = $field.children('.jsAlchemyValidationTooltip');\n                                    const blockTop = $field.offset().top;\n\n                                    topMostPosition = -100 + ( blockTop > topMostPosition ? blockTop : topMostPosition );\n\n                                    if( $tooltip[0] ) {\n                                        $tooltip.attr('data-show', true).find('.jsAlchemyTooltipText').text(messsages[alchemy.id]);\n\n                                        $field.addClass('alchemy__field--invalid').parents('.repeatee').addClass('repeatee--expanded');\n\n                                        popperInstances[alchemy.id] = Popper.createPopper( $field[0], $tooltip[0], {\n                                            placement: 'top',\n                                            modifiers: [\n                                                {\n                                                    name: 'flip',\n                                                    options: {\n                                                        fallbackPlacements: ['top-start'],\n                                                    },\n                                                }\n                                            ],\n                                        } );\n\n                                        $field.one('hover focus', () => {\n                                            if( $field.hasClass('alchemy__field--invalid') ) {\n                                                $field.removeClass('alchemy__field--invalid');\n\n                                                if( popperInstances[alchemy.id] ) {\n                                                    popperInstances[alchemy.id].destroy();\n\n                                                    $tooltip.removeAttr('data-show');\n                                                }\n                                            }\n                                        });\n\n                                        if( topMostPosition ) {\n                                            $('html').add('body').animate({ scrollTop: topMostPosition }, 500);\n                                        }\n                                    }\n                                }\n                            });\n                        }\n\n                        $button.next('.jsAlchemyLoader').addClass('alchemy__spinner--hidden');\n                    },\n                    complete: () => {\n                        $button.removeAttr('disabled');\n                    }\n                });\n            });\n        });\n\n        if( $metaboxes[0] ) {\n            const $postForm = $('#post');\n            const $postBox = $metaboxes.closest('.postbox');\n\n            $postBox.find('.hndle').removeClass('hndle'); // this removes dnd for metaboxes\n\n            // this removes metaboxes sorting buttons (WP 5.5). It is needed not to break WYSIWYGs\n            $postBox.find('.handle-order-higher').remove();\n            $postBox.find('.handle-order-lower').remove();\n\n            if( $postForm[0] ) {\n                $('#publish, #save-post').one('click', function(e) {\n                    e.preventDefault();\n\n                    const $trigger = $(this);\n\n                    $trigger.attr('disabled', true);\n\n                    save_metadata($trigger);\n                });\n            } else if( wp.data && wp.data.subscribe ) {\n                let saved = true; // helps against multiple save calls\n\n                wp.data.subscribe(() => {\n                    const editor = wp.data.select('core/editor');\n\n                    if ( editor.isSavingPost() ) {\n                        saved = false;\n                    } else {\n                        if ( ! saved ) {\n                            save_metadata();\n\n                            saved = true;\n                        }\n                    }\n                });\n            }\n        }\n\n        if( $userProfileContainer[0] ) {\n            const $profileForm = $('#your-profile');\n\n            let saved = false;\n\n            if( $profileForm[0] ) {\n                $profileForm.on('submit', e => {\n                    if( ! saved ) {\n                        const $fields = $userProfileContainer.children('.jsAlchemyField');\n                        const constrFields = [];\n\n                        $profileForm.find('[type=\"submit\"]').attr('disabled', true)\n\n                        $fields.each((i, field) => {\n                            const $field = $(field);\n\n                            if( 'sections' === $field.data('alchemy').type ) {\n                                const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\n\n                                if( $children[0] ) {\n                                    $children.each((i, child) => {\n                                        constrFields.push($(child));\n                                    });\n                                }\n                            } else {\n                                constrFields.push($field);\n                            }\n                        });\n\n                        const fieldsPromises = $(constrFields).map((i, field) => {\n                            const alchemy = $(field).data('alchemy');\n\n                            return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\n                        }).get();\n\n                        const userProfileData = AlchemyData['save-user-profile'];\n\n                        Promise.all(fieldsPromises).then(values => {\n                            data.append('_wpnonce', userProfileData.nonce);\n                            data.append('user-id', userProfileData.userID);\n                            data.append('values', JSON.stringify(values));\n\n                            $.ajax({\n                                method: \"POST\",\n                                url: userProfileData.url,\n                                dataType: 'json',\n                                processData: false,\n                                contentType: false,\n                                data: data,\n                                success: () => {\n                                    $profileForm.submit();\n                                }\n                            });\n                        });\n\n                        e.preventDefault();\n                    } else {\n                        $profileForm.find('[type=\"submit\"]').removeAttr('disabled').addClass('disabled').click();\n                    }\n\n                    saved = true;\n                });\n            }\n        }\n\n        function save_metadata($trigger) {\n            const $fields = $metaboxes.children('.metabox__fields').children('.jsAlchemyField');\n            const constrFields = [];\n\n            $fields.each((i, field) => {\n                const $field = $(field);\n\n                if( 'sections' === $field.data('alchemy').type ) {\n                    const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\n\n                    if( $children[0] ) {\n                        $children.each((i, child) => {\n                            constrFields.push($(child));\n                        });\n                    }\n                } else {\n                    constrFields.push($field);\n                }\n            });\n\n            const fieldsPromises = $(constrFields).map((i, field) => {\n                const alchemy = $(field).data('alchemy');\n\n                return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\n            }).get();\n\n            const saveMetaboxesData = AlchemyData['save-metaboxes'];\n\n            Promise.all(fieldsPromises).then(values => {\n                data.append('_wpnonce', saveMetaboxesData.nonce);\n                data.append('post-id', saveMetaboxesData.postID);\n                data.append('values', JSON.stringify(values));\n\n                $.ajax({\n                    method: \"POST\",\n                    url: saveMetaboxesData.url,\n                    dataType: 'json',\n                    processData: false,\n                    contentType: false,\n                    data: data,\n                    success: () => {\n                        if( $trigger && $trigger[0] ) {\n                            $trigger.removeAttr('disabled').click();\n                        }\n                    }\n                });\n            });\n        }\n    });\n})(window, document, jQuery);\n"]}